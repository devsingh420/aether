generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserType {
  INDIVIDUAL
  BUSINESS
}

enum Role {
  BUYER
  FARM_OWNER
  ADMIN
}

enum Grade {
  A
  B
  C
}

enum OrderStatus {
  PENDING
  PAID
  CONFIRMED
  PREPARING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum OrderType {
  RETAIL
  WHOLESALE
}

enum InquiryStatus {
  PENDING
  NEGOTIATING
  ACCEPTED
  REJECTED
  CONVERTED
  EXPIRED
}

enum PaymentMethod {
  PROMPTPAY
  CREDIT_CARD
  BANK_TRANSFER
  ESCROW
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum DeliveryStatus {
  PENDING
  PICKUP_SCHEDULED
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED
}

enum NotificationType {
  ORDER_CONFIRMED
  ORDER_SHIPPED
  ORDER_DELIVERED
  PAYMENT_RECEIVED
  INQUIRY_RECEIVED
  INQUIRY_RESPONSE
  LOW_STOCK
  PAYOUT_PROCESSED
}

// ==================== MODELS ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String?
  name          String
  phone         String?
  company       String?
  type          UserType  @default(INDIVIDUAL)
  role          Role      @default(BUYER)
  lineUserId    String?   @unique
  avatar        String?
  verified      Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  farm           Farm?
  orders         Order[]
  inquiries      Inquiry[]
  addresses      Address[]
  notifications  Notification[]
  refreshTokens  RefreshToken[]

  @@index([email])
  @@index([lineUserId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model Address {
  id          String  @id @default(cuid())
  userId      String
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  label       String  @default("Home")
  name        String
  phone       String
  address     String
  subdistrict String
  district    String
  province    String
  postalCode  String
  isDefault   Boolean @default(false)
  notes       String?

  @@index([userId])
}

model Farm {
  id              String    @id @default(cuid())
  ownerId         String    @unique
  owner           User      @relation(fields: [ownerId], references: [id])
  name            String
  slug            String    @unique
  location        String
  province        String
  description     String
  image           String
  size            String
  established     Int
  rating          Decimal   @default(5.0) @db.Decimal(3, 2)
  reviewCount     Int       @default(0)
  verified        Boolean   @default(false)
  coldChain       Boolean   @default(false)
  escrowEnabled   Boolean   @default(false)
  bankAccount     Json?
  deliveryBangkok String?   @default("2-3 days")
  deliveryRegional String?  @default("3-5 days")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  certifications FarmCertification[]
  products       Product[]
  orders         Order[]
  inquiries      Inquiry[]
  payouts        Payout[]

  @@index([slug])
  @@index([province])
  @@index([verified])
}

model FarmCertification {
  id        String   @id @default(cuid())
  farmId    String
  farm      Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name      String
  issuedBy  String?
  issuedAt  DateTime?
  expiresAt DateTime?
  document  String?
  createdAt DateTime @default(now())

  @@index([farmId])
}

model Product {
  id              String    @id @default(cuid())
  farmId          String
  farm            Farm      @relation(fields: [farmId], references: [id])
  name            String
  slug            String
  category        String
  subcategory     String?
  description     String
  specifications  String[]
  grade           Grade
  images          String[]
  unit            String    @default("kg")
  retailUnit      String
  retailQty       Decimal   @db.Decimal(10, 2)
  retailPrice     Decimal   @db.Decimal(10, 2)
  pricingTiers    Json      // [{min, max, price}]
  moqRetail       Int       @default(1)
  moqWholesale    Int
  stock           Int
  reservedStock   Int       @default(0)
  harvestSchedule String?
  shelfLife       String?
  storageTemp     String?
  needsColdChain  Boolean   @default(false)
  batchId         String?
  active          Boolean   @default(true)
  priceUpdated    DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  orderItems    OrderItem[]
  inquiries     Inquiry[]

  @@unique([farmId, slug])
  @@index([category])
  @@index([farmId])
  @@index([grade])
  @@index([active])
}

model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique
  userId          String
  user            User        @relation(fields: [userId], references: [id])
  farmId          String
  farm            Farm        @relation(fields: [farmId], references: [id])
  inquiryId       String?     @unique
  inquiry         Inquiry?    @relation(fields: [inquiryId], references: [id])
  status          OrderStatus @default(PENDING)
  type            OrderType   @default(RETAIL)
  subtotal        Decimal     @db.Decimal(12, 2)
  deliveryFee     Decimal     @db.Decimal(10, 2)
  platformFee     Decimal     @db.Decimal(10, 2)
  total           Decimal     @db.Decimal(12, 2)
  deliveryMethod  String
  deliveryAddress Json
  scheduledDate   DateTime?
  paidAt          DateTime?
  confirmedAt     DateTime?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  cancelledAt     DateTime?
  notes           String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  items           OrderItem[]
  payment         Payment?
  delivery        Delivery?

  @@index([userId])
  @@index([farmId])
  @@index([status])
  @@index([orderNumber])
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  productName String
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(12, 2)

  @@index([orderId])
  @@index([productId])
}

model Inquiry {
  id              String        @id @default(cuid())
  inquiryNumber   String        @unique
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  farmId          String
  farm            Farm          @relation(fields: [farmId], references: [id])
  productId       String
  product         Product       @relation(fields: [productId], references: [id])
  quantity        Decimal       @db.Decimal(10, 2)
  proposedPrice   Decimal       @db.Decimal(10, 2)
  agreedPrice     Decimal?      @db.Decimal(10, 2)
  deliveryMethod  String
  recurring       Boolean       @default(false)
  recurringDay    String?
  status          InquiryStatus @default(PENDING)
  message         String?
  expiresAt       DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  messages        InquiryMessage[]
  order           Order?

  @@index([userId])
  @@index([farmId])
  @@index([productId])
  @@index([status])
  @@index([inquiryNumber])
}

model InquiryMessage {
  id          String   @id @default(cuid())
  inquiryId   String
  inquiry     Inquiry  @relation(fields: [inquiryId], references: [id], onDelete: Cascade)
  senderId    String
  senderType  String   // 'BUYER' | 'FARM'
  message     String
  attachment  String?
  createdAt   DateTime @default(now())

  @@index([inquiryId])
}

model Payment {
  id              String        @id @default(cuid())
  orderId         String        @unique
  order           Order         @relation(fields: [orderId], references: [id])
  method          PaymentMethod
  amount          Decimal       @db.Decimal(12, 2)
  currency        String        @default("THB")
  status          PaymentStatus @default(PENDING)
  stripeIntentId  String?       @unique
  stripeResponse  Json?
  qrCodeUrl       String?
  paidAt          DateTime?
  expiresAt       DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([stripeIntentId])
}

model Payout {
  id          String       @id @default(cuid())
  farmId      String
  farm        Farm         @relation(fields: [farmId], references: [id])
  amount      Decimal      @db.Decimal(12, 2)
  fee         Decimal      @db.Decimal(10, 2)
  netAmount   Decimal      @db.Decimal(12, 2)
  status      PayoutStatus @default(PENDING)
  bankAccount Json
  reference   String?
  processedAt DateTime?
  createdAt   DateTime     @default(now())

  @@index([farmId])
  @@index([status])
}

model Delivery {
  id              String         @id @default(cuid())
  orderId         String         @unique
  order           Order          @relation(fields: [orderId], references: [id])
  provider        String
  trackingNumber  String?
  status          DeliveryStatus @default(PENDING)
  estimatedAt     DateTime?
  pickedUpAt      DateTime?
  deliveredAt     DateTime?
  proofOfDelivery String?
  coldChainLog    Json?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([trackingNumber])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String
  data      Json?
  read      Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([read])
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  icon        String?
  description String?
  sortOrder   Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  subcategories Subcategory[]

  @@index([slug])
}

model Subcategory {
  id         String   @id @default(cuid())
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  name       String
  slug       String
  sortOrder  Int      @default(0)
  active     Boolean  @default(true)

  @@unique([categoryId, slug])
  @@index([categoryId])
}
